## 前端架构 (以小程序为例)

本文就谈谈前端架构, 以小程序 (`基于 mpvue`) 为例子

### 有幸独立参与了一款小程序的开发, 即将是两款

- 都是基于 `mpvue` 开发, 毕竟本人比较精通 Vue, 而且本人也懒得再去学小程序那恶心的语法...  
- 京东不是也开源了个 `Taro`, 用 React 写小程序, 本人也比较精通 React 啊 🤓, 可惜开源的迟了, 早点开源, 再多 发(xiu) 几个 版本(Bug), 说不定我还能用上呢, 毕竟 Vue 我也是重操旧业, 第一家公司在用的, 也算是比较早期的使用者了, 后来换公司了就全面切到了 React 上

#### mpvue

简单粗暴的介绍一下 mpvue, 你可以直接看成是 **compiler** + **loader**, 借助 `webpack` 编译成适合小程序端的目录文件与语法, 所以你可以愉快的写 Vue 了


### 前端架构

架构 听着就是那么装逼又高大上的词。  
每个人对架构的理解都不一样, 我就说说我个人的 前端架构 的理解, 以小程序端的设计为例。

说起前端架构, 总是逃不开一大堆设计:

#### 1. 工程目录  

> 一个好的工程目录, 对开发体验与效率上带来了很大的隐性增长, 作为曾经维护好多老工程的人 深有体会。

```dir
├─ build/                  # 打包编译脚本
├─ config/                 # 打包编译相关配置
├─ node_modules/           # 不解释
├─ scripts/                # 应用相关脚本, 如 应用环境切换
├─ static/                 # 图片等静态资源
├─ src/                    # 前端工程
│   ├─── components/              # 组件文件夹
│   ├─── config/                  # 配置相关
│   │       ├─── mina/                   # 小程序底层接口封装
│   │       ├─── adapter.js              # 适配器 (整合各平台接口, 未来用于多端复用)
│   │       ├─── app.js                  # 应用级别信息 (存储系统信息 以及 重要值)
│   │       ├─── env.json                # 环境文件 (ignore, scrips 文件夹里有切换环境脚本, 会根据命令自动 生成/修改 该文件)
│   │       ├─── host.js                 # 存放各种可用接口的 host
│   ├─── mixins/                  # vue mixin
│   ├─── pages/                   # 页面文件
│   ├─── plugins/                 # 插件集成 (其实可以全部抽成公司内部三方包就好了, 然后公司自建的 npm 服务安装, 那这个文件夹基本就不需要了)
│   │       ├─── router/                 # 自定义路由栈
│   │       ├─── event/                  # 自定义事件机制
│   │       ├─── ......                  # 其他插件
│   ├─── routes/                  # 配置相关
│   │       ├─── build.js                # 路由暴露文件 (用于编译, 里面有一些 node 代码)
│   │       ├─── index.js                # 路由暴露文件 (应用引用)
│   │       ├─── routes.json             # 实际路由文件, 工程大了再拆分
│   ├─── service/                 # 存放接口调用相关服务
│   ├─── styles/                  # 样式目录
│   ├─── utils/                   # 常用方法工具包
│   ├─── vuex/                    # 不解释
│   ├─── App.vue                  # 入口 Vue 文件 (引入全局样式、分享反馈上报等)
│   ├─── main.js                  # 入口文件 (小程序背景相关配置、初始化插件等)
```
#### 2. 代码风格/编程思想  
  - 代码风格很简单, 我这边统一的 `Standard` 风格
  - **OOP** 就不说了, **FP** 想用就用呗, 当然 **极大数据量** 的情况下, 个人不建议用 **FP**, 要不你自己试试(迷之微笑 😊)
  - 善用 **设计模式**, 我们要 **优雅!** 不要 **污!**
#### 3. 通信机制/事件机制
  - 组件啊, 页面啊通信就不多说了, 全局直接上一个 **vuex** 先
  - 事件机制是很有必要的, 尤其在小程序里, 比如一个场景: 当你要使用小程序的下拉刷新的时候, 而你不使用小程序的 tab, 即你的多个页面共享一个下拉刷新 (这种情况是由于用户的权限可能会带来完全不同的 tab 造成的), 然后这个刷新事件就比较恶心了, 当然最简单的就是 直接容器组件存放子页面的刷新回调, 通过判断当前激活的 tab, 来调用不同的刷新回调。最开始, 我也是用这种方法, 但是感觉太不优雅了, 每次要显式的存个变量, 操作这个变量。所以我觉得要设计一个 **事件机制** 做 **订阅发布**。实际代码就不上了, 估计大家都会, 唯一要注意的就是做好 **事件的移除**。另外就是除了上面这个场景, 我相信当你的应用越来越复杂的时候, 肯定会碰到需要的场景, 比如跨页面调用, 当然你也可以说用 `vuex` 啊, 不过这不就和我上面最开始用的方法一样了吗?
#### 4. 路由设计
  - 小程序路由: 相当于 url 传参, 参数数据结构不够丰富, 所以我在项目里重写了一个路由栈, 兼容 `vue-router` (万一代码要跨平台复用, 嘿嘿, 猥琐脸...)
  - 路由的设计无非就是 **栈**, 后进先出, 其他一些解析规则、钩子啥的就不多说了, 业界都有现成的例子教程, 唯一要注意的就是 要做好页面卸载的时候清除对应路由 (小程序里就是 **onUnload** 来达到监听返回的操作)
#### 5. 状态管理/应用环境管理
  - 全局状态的话, 直接上 **vuex**
  - 应用相关环境状态等外部影响的变量, 通过脚本来动态修改变量就好了
#### 6. 前端微服务/领域化设计
  - 领域驱动设计 (下面简称 DDD), 这玩意儿是在服务端兴起的一个概念, 之前和同事讨论到这东西, 其实前端也的确可以引入 DDD, 但是吧, 我觉得在 **前端的 DDD** 实际上做的更像是 **前端微服务**, 当然就是个人理解问题, 我觉得在前端的 **服务层** (即接口层) 是可以用微服务的概念来做的, 而 DDD 就很抽象了, 我觉得 `领域` 包含了 `service`。而在前端, 我觉得还是微服务概念实行起来, 脉络更加清晰
#### 7. 组件/模块设计
  - ...
#### 8. 埋点/异常设计
  - ...
#### 9. 跨端复用/平台兼容
  - ...
#### 10. 持续集成/自动化测试
  - ...

未完待续......
